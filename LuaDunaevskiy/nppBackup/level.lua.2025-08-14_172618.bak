
local script_name = 'Level'
local script_version = '07/03/2025'
local hook = require 'hooks'
local ffi = require 'ffi'
local imgui = require 'mimgui' -- Используем mimgui вместо imgui
local encoding = require 'encoding'
encoding.default = 'CP1251'
u8 = encoding.UTF8

local gameHandle = getModuleHandle('samp.dll')
local settings_file = getGameDirectory() .. "\\moonloader\\level_settings.json"
local json = require 'dkjson'

-- Настройки по умолчанию
local settings = {
    showPing = true,
    showLevel = true,
    pingPosition = 'after', -- before, after, above, below
    levelPosition = 'after', -- before, after, above, below
    pingColor = { r = 0.0, g = 1.0, b = 0.0, a = 1.0 }, -- Зеленый
    levelColor = { r = 0.0, g = 1.0, b = 0.0, a = 1.0 } -- Зеленый
}

-- Окно ImGui
local showSettings = imgui.ImBool(false)

-- Функция для логирования
function logToFile(message)
    local file = io.open(getGameDirectory() .. "\\moonloader\\level.log", "a")
    if file then
        file:write(os.date("[%Y-%m-%d %H:%M:%S] ") .. message .. "\n")
        file:close()
    end
end

-- Загрузка настроек
function loadSettings()
    local file = io.open(settings_file, "r")
    if file then
        local content = file:read("*a")
        file:close()
        local success, result = pcall(json.decode, content)
        if success and result then
            settings = result
            logToFile("Настройки загружены: " .. json.encode(settings))
        else
            logToFile("Ошибка загрузки настроек: " .. tostring(result))
        end
    else
        logToFile("Файл настроек не найден, используются настройки по умолчанию")
    end
end

-- Сохранение настроек
function saveSettings()
    local file = io.open(settings_file, "w")
    if file then
        file:write(json.encode(settings, { indent = true }))
        file:close()
        logToFile("Настройки сохранены")
    else
        logToFile("Ошибка сохранения настроек")
    end
end

function getSampVersion()
    if gameHandle == 0 then
        sampAddChatMessage('{FF0000}Не удалось определить версию SA:MP', -1)
        print('{FF0000}Не удалось определить версию SA:MP')
        logToFile("Не удалось определить версию SA:MP")
        thisScript():unload()
        return nil
    else
        local cast = ffi.cast('long*', gameHandle + 60)[0]
        local isR1 = ffi.cast('unsigned int*', gameHandle + cast + 40)[0] ~= 836816
        if isR1 then
            print("Detected SA:MP R1 (0.3.7)")
            logToFile("Detected SA:MP R1 (0.3.7)")
            return 'R1'
        else
            print("Detected SA:MP R3 (0.3.DL)")
            logToFile("Detected SA:MP R3 (0.3.DL)")
            return 'R3'
        end
    end
end

function main()
    if not isSampLoaded() or not isSampfuncsLoaded() then
        print("Ошибка: SA:MP или sampfuncs не загружены")
        logToFile("Ошибка: SA:MP или sampfuncs не загружены")
        return
    end
    while not isSampAvailable() do wait(100) end

    -- Проверка загрузки mimgui
    if not imgui then
        sampAddChatMessage("[Level] {FF0000}Ошибка: mimgui не загружен!", -1)
        print("Ошибка: mimgui не загружен")
        logToFile("Ошибка: mimgui не загружен")
        return
    end

    loadSettings()

    local base = gameHandle
    local offset
    local sampVersion = getSampVersion()
    if not sampVersion then return end

    if sampVersion == "R1" then
        offset = 0x70F4E
        sampAddChatMessage("{FFFFFF}SAMP Version: {00FF00}R1", -1)
        logToFile("SAMP Version: R1")
    elseif sampVersion == "R3" then
        offset = 0x74E3F
        sampAddChatMessage("{FFFFFF}SAMP Version: {00FF00}R3", -1)
        logToFile("SAMP Version: R3")
    end

    renderNick = hook.call.new(
        'int(__cdecl *)(char* buf, const char* fmt, const char* nick, int id, int score, int ping)',
        renderNick,
        base + offset
    )

    -- Регистрация команды /level
    sampRegisterChatCommand('level', function()
        showSettings.v = not showSettings.v
        sampAddChatMessage("[Level] Окно настроек: " .. tostring(showSettings.v), 0xFFFF00)
        logToFile("Команда /level вызвана, showSettings.v = " .. tostring(showSettings.v))
    end)

    -- Инициализация ImGui
    imgui.Process = true
    while true do
        wait(0)
        imgui.Process = showSettings.v
    end
end

function renderNick(buf, fmt, nick, id)
    local score = sampGetPlayerScore(id) or 0
    local ping = sampGetPlayerPing(id) or 0
    local formatStr = '%s [%d]'
    local args = { nick, id }

    -- Формирование формата в зависимости от настроек
    if settings.showLevel then
        local levelStr = string.format('[lvl: %d]', score)
        local levelColor = string.format('{%02X%02X%02X}', 
            math.floor(settings.levelColor.r * 255), 
            math.floor(settings.levelColor.g * 255), 
            math.floor(settings.levelColor.b * 255))
        if settings.levelPosition == 'before' then
            formatStr = levelColor .. levelStr .. ' ' .. formatStr
        elseif settings.levelPosition == 'after' then
            formatStr = formatStr .. ' ' .. levelColor .. levelStr
        elseif settings.levelPosition == 'above' then
            formatStr = levelColor .. levelStr .. '\n' .. formatStr
        elseif settings.levelPosition == 'below' then
            formatStr = formatStr .. '\n' .. levelColor .. levelStr
        end
    end

    if settings.showPing then
        local pingStr = string.format('[ping: %d]', ping)
        local pingColor = string.format('{%02X%02X%02X}', 
            math.floor(settings.pingColor.r * 255), 
            math.floor(settings.pingColor.g * 255), 
            math.floor(settings.pingColor.b * 255))
        if settings.pingPosition == 'before' then
            formatStr = pingColor .. pingStr .. ' ' .. formatStr
        elseif settings.pingPosition == 'after' then
            formatStr = formatStr .. ' ' .. pingColor .. pingStr
        elseif settings.pingPosition == 'above' then
            formatStr = pingColor .. pingStr .. '\n' .. formatStr
        elseif settings.pingPosition == 'below' then
            formatStr = formatStr .. '\n' .. pingColor .. pingStr
        end
    end

    return renderNick(buf, formatStr, unpack(args))
end

-- ImGui интерфейс
function imgui.OnDrawFrame()
    if showSettings.v then
        imgui.ShowCursor = true
        local screenX, screenY = getScreenResolution()
        imgui.SetNextWindowSize(imgui.ImVec2(400, 300), imgui.Cond.FirstUseEver)
        imgui.SetNextWindowPos(imgui.ImVec2(screenX / 2, screenY / 2), imgui.Cond.FirstUseEver, imgui.ImVec2(0.5, 0.5))
        imgui.Begin(u8'Настройки Level', showSettings, imgui.WindowFlags.NoCollapse)
        
        imgui.Text(u8'Настройки отображения')
        imgui.Separator()
        
        if imgui.Checkbox(u8'Показывать уровень', imgui.ImBool(settings.showLevel)) then
            settings.showLevel = not settings.showLevel
            saveSettings()
        end
        imgui.Text(u8'Положение уровня:')
        if imgui.RadioButton(u8'Перед ником', settings.levelPosition == 'before') then 
            settings.levelPosition = 'before'
            saveSettings()
        end
        imgui.SameLine()
        if imgui.RadioButton(u8'После ника', settings.levelPosition == 'after') then 
            settings.levelPosition = 'after'
            saveSettings()
        end
        if imgui.RadioButton(u8'Над ником', settings.levelPosition == 'above') then 
            settings.levelPosition = 'above'
            saveSettings()
        end
        imgui.SameLine()
        if imgui.RadioButton(u8'Под ником', settings.levelPosition == 'below') then 
            settings.levelPosition = 'below'
            saveSettings()
        end
        imgui.Text(u8'Цвет уровня:')
        local levelColor = imgui.ImFloat4(settings.levelColor.r, settings.levelColor.g, settings.levelColor.b, settings.levelColor.a)
        if imgui.ColorEdit4('##LevelColor', levelColor) then
            settings.levelColor.r = levelColor.x
            settings.levelColor.g = levelColor.y
            settings.levelColor.b = levelColor.z
            settings.levelColor.a = levelColor.w
            saveSettings()
        end

        imgui.Separator()
        
        if imgui.Checkbox(u8'Показывать пинг', imgui.ImBool(settings.showPing)) then
            settings.showPing = not settings.showPing
            saveSettings()
        end
        imgui.Text(u8'Положение пинга:')
        if imgui.RadioButton(u8'Перед ником##ping', settings.pingPosition == 'before') then 
            settings.pingPosition = 'before'
            saveSettings()
        end
        imgui.SameLine()
        if imgui.RadioButton(u8'После ника##ping', settings.pingPosition == 'after') then 
            settings.pingPosition = 'after'
            saveSettings()
        end
        if imgui.RadioButton(u8'Над ником##ping', settings.pingPosition == 'above') then 
            settings.pingPosition = 'above'
            saveSettings()
        end
        imgui.SameLine()
        if imgui.RadioButton(u8'Под ником##ping', settings.pingPosition == 'below') then 
            settings.pingPosition = 'below'
            saveSettings()
        end
        imgui.Text(u8'Цвет пинга:')
        local pingColor = imgui.ImFloat4(settings.pingColor.r, settings.pingColor.g, settings.pingColor.b, settings.pingColor.a)
        if imgui.ColorEdit4('##PingColor', pingColor) then
            settings.pingColor.r = pingColor.x
            settings.pingColor.g = pingColor.y
            settings.pingColor.b = pingColor.z
            settings.pingColor.a = pingColor.w
            saveSettings()
        end

        imgui.End()
    end
end
