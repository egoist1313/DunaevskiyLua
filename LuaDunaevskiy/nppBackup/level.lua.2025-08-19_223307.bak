local script_name = 'Level'
local script_version = '2.0.0'
script_properties("work-in-pause")
local hook = require 'hooks'
local ffi = require 'ffi'
local imgui = require 'imgui'
local encoding = require 'encoding'
local json = require 'json'
local dlstatus = require('moonloader').download_status
encoding.default = 'CP1251'
local u8 = encoding.UTF8
local gameHandle = getModuleHandle('samp.dll')
local settings_file = getWorkingDirectory() .. "\\LuaDunaevskiy\\config\\Level.json"
-- Настройки по умолчанию
local default_settings = {
    showPing = true,
    showLevel = true,
    pingNewLine = false,
    levelNewLine = false,
    pingBefore = false,
    levelBefore = false
}
local settings = default_settings
local showSettings = imgui.ImBool(false)
local animAlpha = imgui.ImFloat(0.0)
-- Функция для сохранения настроек
local function save_settings()
    local config_folder = getWorkingDirectory() .. "\\LuaDunaevskiy\\config"
    if not doesDirectoryExist(config_folder) then
        createDirectory(config_folder)
    end
    local file = io.open(settings_file, "w")
    if file then
        file:write(json.encode(settings))
        file:close()
    else
    end
end
-- Функция для загрузки настроек
local function load_settings()
    if doesFileExist(settings_file) then
        local file = io.open(settings_file, "r")
        if file then
            local content = file:read("*a")
            file:close()
            if content and content:match("%S") then
                local success, data = pcall(json.decode, content)
                if success and data then
                    settings = data
                    -- Проверяем, что все необходимые ключи присутствуют
                    for k, v in pairs(default_settings) do
                        if settings[k] == nil then
                            settings[k] = v
                        end
                    end
                else
                    settings = default_settings
                    save_settings()
                end
            else
                save_settings()
            end
        else
            save_settings()
        end
    else
        save_settings()
    end
end
-- Функция загрузки JSON (адаптирована из ScriptUpdater)
local function downloadJson(url, callback)
    local temp_file = getWorkingDirectory() .. "\\moonloader\\LuaDunaevskiy\\temp_access.json"
    downloadUrlToFile(url, temp_file, function(id, status, p1, p2)
        if status == dlstatus.STATUSEX_ENDDOWNLOAD then
            local file = io.open(temp_file, "rb")
            if file then
                local content = file:read("*a"):gsub("^\239\187\191", ""):gsub("[\r\n]+$", "")
                file:close()
                pcall(os.remove, temp_file) -- Удаляем временный файл
                if content == "" then
                    callback(false, "Пустой файл")
                    return
                end
                local success, result = pcall(json.decode, content)
                if success and result then
                    callback(true, result)
                else
                    callback(false, "Ошибка парсинга JSON")
                end
            else
                callback(false, "Не удалось открыть файл")
            end
        elseif status == dlstatus.STATUSEX_ERROR then
            callback(false, tostring(p1))
        end
    end)
end
-- Функция проверки доступа
local function checkAccess()
    local playerName = sampGetPlayerNickname(select(2, sampGetPlayerIdByCharHandle(PLAYER_PED))) or ""
    local serverIP = sampGetCurrentServerAddress() or ""
    local currentDate = os.date("%Y-%m-%d")
    local url = "https://raw.githubusercontent.com/egoist1313/DunaevskiyLua/main/access.json"
    local accessChecked = imgui.ImBool(false)
    local accessGranted = imgui.ImBool(false)
    downloadJson(url, function(success, data)
        if not success then
            accessChecked.v = true
            return
        end
        for _, player in ipairs(data.players or {}) do
            if player.nickname == playerName then
                for _, ip in ipairs(player.server_ip or {}) do
                    if serverIP == ip or serverIP:match(ip) then
                        for _, script in ipairs(player.allowed_scripts or {}) do
                            if script == "Level" then
                                if player.expires_at and player.expires_at >= currentDate then
                                    accessGranted.v = true
                                else
                                end
                            end
                        end
                    end
                end
            end
        end
        if not accessGranted.v then
            sampAddChatMessage("[Level] Доступ запрещен", 0xFF0000)
            thisScript():unload()
        end
        accessChecked.v = true
    end)
    return accessChecked, accessGranted
end
function main()
    -- Проверка SA:MP
    if not isSampAvailable() then
        return
    end
    -- Проверка доступа при запуске
    local accessChecked, accessGranted = checkAccess()
    local startTime = os.clock()
    local timeout = 30 -- 30 секунд таймаут
    while not accessChecked.v and (os.clock() - startTime) < timeout do
        wait(100)
    end
    -- Если доступ не был проверен или не разрешен
    if not accessChecked.v then
        return
    end
    if not accessGranted.v then
        return
    end
    -- Загружаем настройки
    load_settings()
    local offset = ffi.cast('long*', gameHandle + 60)[0]
    local isR1 = ffi.cast('unsigned int*', gameHandle + offset + 40)[0] ~= 836816
    offset = isR1 and 0x70F4E or 0x74E3F
    renderNick = hook.call.new(
        'int(__cdecl *)(char* buf, const char* fmt, const char* nick, int id, int score, int ping)',
        renderNick,
        gameHandle + offset
    )
    sampRegisterChatCommand('level', function()
        showSettings.v = not showSettings.v
        animAlpha.v = 0.0
    end)
    -- Главный цикл с постоянной проверкой ника
    local lastNick = sampGetPlayerNickname(select(2, sampGetPlayerIdByCharHandle(PLAYER_PED))) or ""
    while true do
        wait(100)
        imgui.Process = showSettings.v
        if showSettings.v then
            animAlpha.v = math.min(animAlpha.v + 0.05, 1.0)
        else
            animAlpha.v = 0.0
        end
        -- Проверка изменения ника
        local currentNick = sampGetPlayerNickname(select(2, sampGetPlayerIdByCharHandle(PLAYER_PED))) or ""
        if currentNick ~= lastNick then
            lastNick = currentNick
            local checked, granted = checkAccess()
            local checkStartTime = os.clock()
            while not checked.v and (os.clock() - checkStartTime) < timeout do
                wait(100)
            end
            if not checked.v then
                thisScript():unload()
                return
            end
            if not granted.v then
                thisScript():unload()
                return
            end
        end
    end
end
function renderNick(buf, fmt, nick, id, score, ping)
    local formatStr = '%s [%d]'
    local levelStr = settings.showLevel and string.format('[lvl: %d]', sampGetPlayerScore(id) or 0) or ''
    local pingStr = settings.showPing and string.format('[ping: %d]', sampGetPlayerPing(id) or 0) or ''
    -- Обработка уровня
    if settings.showLevel then
        if settings.levelNewLine then
            formatStr = settings.levelBefore and (levelStr..'\n'..formatStr) or (formatStr..'\n'..levelStr)
        else
            formatStr = settings.levelBefore and (levelStr..' '..formatStr) or (formatStr..' '..levelStr)
        end
    end
    -- Обработка пинга
    if settings.showPing then
        if settings.pingNewLine then
            formatStr = settings.pingBefore and (pingStr..'\n'..formatStr) or (formatStr..'\n'..pingStr)
        else
            formatStr = settings.pingBefore and (pingStr..' '..formatStr) or (formatStr..' '..pingStr)
        end
    end
    return renderNick(buf, formatStr, nick, id, score, ping)
end
imgui.OnDrawFrame = function()
    if not showSettings.v then return end
    -- Стилизация
    imgui.PushStyleColor(imgui.Col.WindowBg, imgui.ImVec4(0.1, 0.1, 0.12, 0.95))
    imgui.PushStyleColor(imgui.Col.TitleBgActive, imgui.ImVec4(0.2, 0.4, 0.8, 1.0))
    imgui.PushStyleColor(imgui.Col.TitleBg, imgui.ImVec4(0.15, 0.15, 0.2, 1.0))
    imgui.PushStyleColor(imgui.Col.FrameBg, imgui.ImVec4(0.2, 0.2, 0.25, 0.8))
    imgui.PushStyleColor(imgui.Col.FrameBgHovered, imgui.ImVec4(0.3, 0.3, 0.35, 0.9))
    imgui.PushStyleColor(imgui.Col.FrameBgActive, imgui.ImVec4(0.4, 0.4, 0.45, 0.9))
    imgui.PushStyleColor(imgui.Col.CheckMark, imgui.ImVec4(0.4, 0.6, 1.0, 1.0))
    imgui.PushStyleColor(imgui.Col.Text, imgui.ImVec4(0.9, 0.9, 0.9, 1.0))
    imgui.PushStyleColor(imgui.Col.Button, imgui.ImVec4(0.2, 0.4, 0.8, 0.7))
    imgui.PushStyleColor(imgui.Col.ButtonHovered, imgui.ImVec4(0.3, 0.5, 0.9, 0.9))
    imgui.PushStyleColor(imgui.Col.ButtonActive, imgui.ImVec4(0.4, 0.6, 1.0, 1.0))
    imgui.PushStyleVar(imgui.StyleVar.WindowRounding, 8.0)
    imgui.PushStyleVar(imgui.StyleVar.FrameRounding, 5.0)
    imgui.PushStyleVar(imgui.StyleVar.ItemSpacing, imgui.ImVec2(12, 10))
    imgui.PushStyleVar(imgui.StyleVar.WindowPadding, imgui.ImVec2(15, 15))
    imgui.PushStyleVar(imgui.StyleVar.Alpha, animAlpha.v)
    -- Центрирование окна
    local windowSize = imgui.ImVec2(400, 390)
    local displaySize = imgui.GetIO().DisplaySize
    imgui.SetNextWindowSize(windowSize, imgui.Cond.FirstUseEver)
    imgui.SetNextWindowPos(imgui.ImVec2(displaySize.x * 0.5, displaySize.y * 0.5), imgui.Cond.FirstUseEver, imgui.ImVec2(0.5, 0.5))
    -- Начало окна без прокрутки
    imgui.Begin(u8'Настройки Level', showSettings, imgui.WindowFlags.NoResize + imgui.WindowFlags.NoCollapse + imgui.WindowFlags.NoScrollbar)
    -- Заголовок
    imgui.TextColored(imgui.ImVec4(0.4, 0.7, 1.0, 1.0), u8'Настройки отображения')
    imgui.Separator()
    imgui.Spacing()
    -- Секция уровня
    imgui.Text(u8'Уровень игрока:')
    if imgui.Checkbox(u8'Показывать уровень', imgui.ImBool(settings.showLevel)) then
        settings.showLevel = not settings.showLevel
        save_settings()
    end
    imgui.Indent(20)
    if imgui.Checkbox(u8'Перед ником', imgui.ImBool(settings.levelBefore)) then
        settings.levelBefore = not settings.levelBefore
        save_settings()
    end
    if imgui.Checkbox(u8'На новой строке', imgui.ImBool(settings.levelNewLine)) then
        settings.levelNewLine = not settings.levelNewLine
        save_settings()
    end
    imgui.Unindent(20)
    imgui.Spacing()
    imgui.Separator()
    imgui.Spacing()
    -- Секция пинга
    imgui.Text(u8'Пинг игрока:')
    if imgui.Checkbox(u8'Показывать пинг', imgui.ImBool(settings.showPing)) then
        settings.showPing = not settings.showPing
        save_settings()
    end
    imgui.Indent(20)
    if imgui.Checkbox(u8'Перед ником##ping', imgui.ImBool(settings.pingBefore)) then
        settings.pingBefore = not settings.pingBefore
        save_settings()
    end
    if imgui.Checkbox(u8'На новой строке##ping', imgui.ImBool(settings.pingNewLine)) then
        settings.pingNewLine = not settings.pingNewLine
        save_settings()
    end
    imgui.Unindent(20)
    imgui.Spacing()
    imgui.Separator()
    imgui.TextColored(imgui.ImVec4(0.6, 0.6, 0.6, 1.0), u8'Level v'..script_version..' by '..script_name)
    imgui.End()
    imgui.PopStyleVar(5)
    imgui.PopStyleColor(11)
end